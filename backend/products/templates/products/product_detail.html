{% extends 'base.html' %}
{% load static %}
{% load product_extras %}
{% load humanize %}

{% block title %}Product Detail{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav class="mx-auto w-full mt-4 max-w-[1200px] px-5">
    <ul class="flex items-center">
        <li class="cursor-pointer">
            <a href="{% url 'product_list' %}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5">
                    <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" />
                    <path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" />
                </svg>
            </a>
        </li>
        <li><span class="mx-2 text-gray-500">&gt;</span></li>
        <li class = "text-gray-500"><a href="{% url 'product_list' %}">catalouge &gt;</a></li>
        <li class="text-gray-500"> {{ product.name }}</li>
    </ul>
</nav>

<section class="container flex-grow mx-auto max-w-[1200px] border-b py-5 lg:grid lg:grid-cols-2 lg:py-10">

    <!-- Product Images Carousel -->
    <!-- Product Images Gallery -->
    <div class="container mx-auto px-4">
        <div class="flex flex-col items-center">
            <!-- Main Swiper (big image, swipeable) -->
                      
          <div
            class="swiper main-swiper w-full max-h-96 rounded border mb-4"
            x-data="{
              items: [
                {% if product.image %}
                { url: '{{ product.image.url }}', type: 'image', thumb: '{{ product.image.url }}' }{% if product.images.all or product.videos.all %},{% endif %}
                {% endif %}
                {% for img in product.images.all %}
                { url: '{{ img.image.url }}', type: 'image', thumb: '{{ img.image.url }}' }{% if not forloop.last or product.videos.all %},{% endif %}
                {% endfor %}
                {% for vid in product.videos.all %}
                { url: '{{ vid.video.url }}', type: 'video', thumb: '{% if vid.thumbnail %}{{ vid.thumbnail.url }}{% else %}{% static "images/video-placeholder.png" %}{% endif %}' }{% if not forloop.last %},{% endif %}
                {% endfor %}
              ]
            }"
          >
            <div class="swiper-wrapper">
              {% if product.image %}
              <!-- Wrap each slide in an `<a>` that opens the lightbox at its index -->
              <a
                href="#"
                class="swiper-slide"
                x-init="$el.addEventListener('click', () => $dispatch('lightbox-open', { group: items, index: 0 }))"
              >
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="object-contain w-full my-automax-h-96"/>
              </a>
              {% endif %}

              {% for image in product.images.all %}
                {% if not product.image or image.image.url != product.image.url %}
                <a
                  href="#"
                  class="swiper-slide"
                  x-init="$el.addEventListener('click', () => $dispatch('lightbox-open', { group: items, index: {{ forloop.counter }} }))"
                >
                  <img src="{{ image.image.url }}" alt="Product Image" class="object-contain w-full max-h-96"/>
                </a>
                {% endif %}
              {% endfor %}

              {% for video in product.videos.all %}
              <a
                href="#"
                class="swiper-slide"
                x-init="$el.addEventListener('click', () => $dispatch('lightbox-open', { group: items, index: {{ product.images.count|add:forloop.counter0 }} }))"
              >
                <video controls class="object-contain w-full max-h-96">
                  <source src="{{ video.video.url }}" type="video/mp4">
                </video>
              </a>
              {% endfor %}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
          </div>



            <!-- Thumbnails (static row, always visible) -->
            <div class="flex gap-2 mt-4 flex-wrap justify-center">
            {% if product.image %}
            <img src="{{ product.image.url }}" alt="Thumbnail"
                class="thumbnail w-20 h-20 object-cover rounded border cursor-pointer"
                data-index="0"/>
            {% endif %}
            {% for image in product.images.all %}
                {% if not product.image or image.image.url != product.image.url %}
                <img src="{{ image.image.url }}" alt="Thumbnail"
                    class="thumbnail w-20 h-20 object-cover rounded border cursor-pointer"
                    data-index="{{ forloop.counter }}"/>
                {% endif %}
            {% endfor %}
            {# Add video thumbnails #}
            {% for video in product.videos.all %}
                <div class="relative thumbnail w-20 h-20 rounded border cursor-pointer group bg-gray-200 overflow-hidden" data-index="{{ forloop.counter0|add:product.images.count }}">
                    
                    {% if video.thumbnail %}
                    <img src="{{ video.thumbnail.url }}" alt="Video Thumbnail"
                        class="object-cover w-full h-full rounded absolute inset-0 z-0" />
                    {% else %}
                    <!-- fallback image or background -->
                    {% endif %}

                    <!-- Play icon centered -->
                    <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                    <svg class="w-8 h-8 text-white drop-shadow-lg opacity-90 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="10" fill="rgba(0,0,0,0.5)"/>
                        <polygon points="7,5 15,10 7,15" fill="white"/>
                    </svg>
                    </div>

                </div>
            {% endfor %}

            </div>
        </div>
    </div>
 




    <!-- Product Info -->
    <div class="mx-auto px-5 lg:px-5">
    <p class="mt-5 font-bold">
    Durum: 
    {% if product.listing_type == 'sale' %}
        <span class="text-green-600">Satılık</span>
    {% elif product.listing_type == 'exchange' %}
        <span class="text-amber-500">Takaslık</span>
    {% endif %}
    </p>
        <h1 class="pt-3 text-2xl font-bold lg:pt-0">{{product.name}}</h2>

        <p class="mt-5 font-bold">Category: <span class="font-normal">{{ product.category.name }}</span></p>
    
        <p class="mt-4 text-4xl font-bold text-violet-900">
           {{ product.price|floatformat:0|intcomma }} TL
        </p>

        <p class="pt-5 text-sm leading-5 text-gray-500">{{ product.description }}</p>

        <!-- Contact Info -->

        <div class="mt-7 flex flex-col gap-4 sm:flex-row sm:gap-6">
            <!-- Contact via Email -->
            <a
                href="mailto:{{ product.email }}"
                class="flex h-12 items-center justify-center rounded bg-violet-900 text-white transition 
                    hover:bg-violet-800 px-6 sm:px-8"
            >
                <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                class="mr-2 h-5 w-5 flex-shrink-0"
                >
                <path
                    fill="#FFFFFF"
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M3.75 5.25L3 6V18L3.75 18.75H20.25L21 18V6L20.25 5.25H3.75ZM4.5 7.6955V17.25H19.5V7.69525L11.9999 14.5136L4.5 7.6955ZM18.3099 6.75H5.68986L11.9999 12.4864L18.3099 6.75Z"
                />
                </svg>
                Contact via Email
            </a>

            <!-- Contact via WhatsApp -->
            <a
                href="https://wa.me/{{ product.whatsapp_number }}"
                target="_blank"
                class="flex h-12 items-center justify-center rounded bg-green-700 text-white transition 
                    hover:bg-green-500 px-6 sm:px-8"
            >
                <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 58 58"
                class="mr-2 h-5 w-5 flex-shrink-0"
                >
                <g>
                    <path
                    fill="#2CB742"
                    d="M0,58l4.988-14.963C2.457,38.78,1,33.812,1,28.5C1,12.76,13.76,0,29.5,0S58,12.76,58,28.5
                        S45.24,57,29.5,57c-4.789,0-9.299-1.187-13.26-3.273L0,58z"
                    />
                    <path
                    fill="#FFFFFF"
                    d="M47.683,37.985c-1.316-2.487-6.169-5.331-6.169-5.331c-1.098-0.626-2.423-0.696-3.049,0.42
                        c0,0-1.577,1.891-1.978,2.163c-1.832,1.241-3.529,1.193-5.242-0.52l-3.981-3.981l-3.981-3.981
                        c-1.713-1.713-1.761-3.41-0.52-5.242c0.272-0.401,2.163-1.978,2.163-1.978c1.116-0.627,1.046-1.951,0.42-3.049
                        c0,0-2.844-4.853-5.331-6.169c-1.058-0.56-2.357-0.364-3.203,0.482l-1.758,1.758c-5.577,5.577-2.831,11.873,2.746,17.45
                        l5.097,5.097l5.097,5.097c5.577,5.577,11.873,8.323,17.45,2.746l1.758-1.758C48.048,40.341,48.243,39.042,47.683,37.985z"
                    />
                </g>
                </svg>
                Contact via WhatsApp
            </a>
        </div>


    </div>
</section>

<!-- Fullscreen images-->



<!-- Product Details Section -->
<section class="container mx-auto max-w-[1200px] px-5 py-5 lg:py-10">
    <h2 class="text-xl">Product Details</h2>
    <p class="mt-4 lg:w-3/4">
        {{ product.description }}
    </p>

    <table class="mt-7 w-full table-auto divide-x divide-y lg:w-1/2">
        <tbody class="divide-x border">
            <tr>
                <td class="border pl-4 font-bold">City</td>
                <td class="border pl-4">{{ product.city }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">District</td>
                <td class="border pl-4">{{ product.province }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">Neighborhood</td>
                <td class="border pl-4">{{ product.neighborhood }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">Street</td>
                <td class="border pl-4">{{ product.street }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">Postal Code</td>
                <td class="border pl-4">{{ product.postal_code }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">Phone</td>
                <td class="border pl-4">{{ product.phone_number }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">WhatsApp</td>
                <td class="border pl-4">{{ product.whatsapp_number }}</td>
            </tr>
            <tr>
                <td class="border pl-4 font-bold">Email</td>
                <td class="border pl-4">{{ product.email }}</td>
            </tr>
        </tbody>
    </table>
</section>


<!-- Exchange Notes -->
{% if product.listing_type == 'exchange' and product.exchange_notes.exists %}
<section class="container mx-auto max-w-[1200px] px-5 py-6">
    <div class="bg-gray-50 rounded-lg shadow-sm p-5">
      <h3 class="text-lg font-semibold text-gray-800">İlana Ait Takas Seçenekleri</h3>
      <p class="text-sm text-gray-600 mt-1">Bu ilanın takas seçenekleri aşağıda mevcuttur.</p>
        
      <div class="mt-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-5 gap-x-6">
        {% for note in product.exchange_notes.all %}
          <div>
            <div class="flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-400 rounded-full inline-block mt-0.5"></span>
              <span class="font-medium text-gray-900">{{ note.category.name }} ile Takaslı</span>
            </div>
            {% if note.items.exists %}
            <ul class="pl-5 mt-1 list-disc text-sm text-gray-700">
              {% for item in note.items.all %}
                <li>{{ item.text }}</li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
    </div>
  </section>
  
{% endif %}



{% if product.listing_type == 'exchange' %}
<section class="container mx-auto max-w-[1200px] px-5 py-10">
  <h2 class="text-xl font-bold mb-4 text-amber-700">Bütçe</h2>

  <div class="border border-yellow-300 bg-yellow-50 rounded-lg p-6">
    <!-- Budget Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="flex items-center gap-2">
        <span class="bg-white px-3 py-1 rounded border border-gray-300 font-medium">Min</span>
        <span class="flex-grow">
          <input type="text" value="{{ product.min_budget }}" class="w-full px-3 py-1 rounded border border-gray-300 bg-white text-right" readonly>
        </span>
        <span class="text-gray-600">₺</span>
      </div>

      <div class="flex items-center gap-2">
        <span class="bg-white px-3 py-1 rounded border border-gray-300 font-medium">Max</span>
        <span class="flex-grow">
          <input type="text" value="{{ product.max_budget }}" class="w-full px-3 py-1 rounded border border-gray-300 bg-white text-right" readonly>
        </span>
        <span class="text-gray-600">₺</span>
      </div>
    </div>

    <!-- Exchange Preference Checkboxes -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-6 text-sm">
    {% for field, label in EXCHANGE_PREFERENCES %}
    <div class="flex items-center gap-2">
        <input
        type="checkbox"
        class="text-blue-600 rounded border-gray-300"
        {% if product|get_attr:field %} checked {% endif %}
        disabled
        >
        <span class="{% if product|get_attr:field %}font-semibold text-gray-800{% else %}text-gray-400{% endif %}">
        {{ label }}
        </span>
    </div>
    {% endfor %}
    </div>

  </div>
</section>
{% endif %}



<!-- Related Products Section -->
<div class="mx-auto max-w-[1200px] px-5 py-10">
  <h2 class="text-xl font-bold mb-6">Önerilen Ürünler</h2>

  <section class="grid grid-cols-2 gap-3 lg:grid-cols-4">
    {% for product in related_products %}
      <div class="flex flex-col h-full">
        <!-- Image and overlay -->
        <div class="relative w-full">
          <div class="aspect-[4/3] w-full bg-gray-100 overflow-hidden">
            <img 
              src="{{ product.image.url }}" 
              alt="{{ product.name }}" 
              class="w-full h-full object-contain bg-white"
            >
          </div>

          <!-- Hover overlay -->
          <div class="absolute inset-0 flex items-center justify-center gap-3 opacity-0 duration-150 hover:opacity-100 bg-black bg-opacity-30">
            <a href="{% url 'product_detail' product.slug %}" class="flex h-8 w-8 cursor-pointer items-center justify-center rounded-full bg-blue-400">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
              </svg>
            </a>
          </div>

          <!-- Badge -->
          <div class="absolute top-2 right-2 rounded-full px-3 py-1 text-[0.7rem] font-bold text-white uppercase tracking-wide shadow 
            {% if product.listing_type == 'exchange' %}
              bg-amber-500
            {% else %}
              bg-green-500
            {% endif %}">
            {% if product.listing_type == 'sale' %}
              Satılık
            {% else %}
              Takas
            {% endif %}
          </div>
        </div>

        <!-- Product content -->
        <div class="flex flex-col justify-between flex-grow mt-4">
          <p class="mt-2 font-semibold text-gray-800">{{ product.name }}</p>

          <!-- Price (same position always) -->
          <p class="font-medium text-violet-900">{{ product.price }} TL</p>

          <!-- Reserve consistent space for optional exchange info -->
          <div class="min-h-[48px] mt-1">
            {% if product.listing_type == 'exchange' %}
              <p class="text-sm text-gray-500 italic">Takas edilebilir:</p>
              {% with categories=product.exchange_for.all %}
                {% if categories and categories|length > 0 %}
                  <p class="text-sm text-gray-800">
                    {% for category in categories|slice:":2" %}
                      {{ category.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    {% if categories|length > 2 %}...{% endif %}
                  </p>
                {% else %}
                  <p class="text-sm text-gray-400">Belirtilmemiş</p>
                {% endif %}
              {% endwith %}
            {% endif %}
          </div>
        </div>

        <!-- Action buttons -->
        <div class="my-5">
          <a href="{% url 'product_detail' product.slug %}">
            <button class="h-10 w-full bg-violet-900 text-white hover:bg-violet-800 transition">View Details</button>
          </a>
        </div>   

      </div>
    {% empty %}
      <p class="col-span-4 text-center text-gray-500">No related products found.</p>
    {% endfor %}
  </section>
</div>




<script>
document.addEventListener('DOMContentLoaded', function () {
  // 1) Initialize the main gallery Swiper
  var mainSwiper = new Swiper('.main-swiper', {
    spaceBetween: 10,
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
  });

  // 2) Initialize the lightbox Swiper (hidden overlay)
  var lightboxSwiper = new Swiper('.lightbox-swiper', {
    spaceBetween: 10,
    navigation: {
      nextEl: '.lightbox-swiper .swiper-button-next',
      prevEl: '.lightbox-swiper .swiper-button-prev',
    },
    keyboard: { enabled: true },
  });



  // 3) Thumbnail click handler for main gallery
  document.querySelectorAll('.thumbnail').forEach(function(thumb, idx) {
    thumb.addEventListener('click', function() {
      // slide main gallery
      mainSwiper.slideTo(idx);
      // open lightbox at same slide
      overlay.classList.remove('hidden');
      lightboxSwiper.slideTo(idx, 0);
      // thumbnail active ring
      document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('ring-2','ring-violet-500'));
      thumb.classList.add('ring-2','ring-violet-500');
    });
  });


});
</script>


{% endblock %}
